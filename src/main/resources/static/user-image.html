<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 이미지 관리</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 10px;
        }
        select {
            padding: 8px;
            width: 200px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 100px;
        }
        .image-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .image-card {
            border: 1px solid #ddd;
            padding: 10px;
            width: 200px;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
        }
        #loginSection {
            margin-bottom: 30px;
        }
        .token-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        #camera-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #camera-view {
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
        }
        #camera-buttons {
            margin-top: 15px;
        }
        #canvas {
            display: none;
        }
        .preview-image {
            max-width: 150px;
            margin-top: 10px;
            border: 1px solid #ddd;
            display: none;
        }
        .nav-links {
            text-align: center;
            margin: 20px 0;
        }
        .nav-links a {
            margin: 0 10px;
            text-decoration: none;
            color: #3498db;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>사용자 이미지 관리</h1>
    
    <div class="nav-links">
        <a href="index.html">메인 페이지</a> |
        <a href="user-audio.html">음성 파일 관리</a> |
        <a href="signup.html">회원가입</a>
    </div>
    
    <div id="loginSection" class="section">
        <h2>로그인</h2>
        <div class="form-group">
            <label for="loginId">아이디:</label>
            <input type="text" id="loginId" name="loginId">
        </div>
        <div class="form-group">
            <label for="password">비밀번호:</label>
            <input type="password" id="password" name="password">
        </div>
        <button id="loginBtn">로그인</button>
        <div class="token-info" id="tokenInfo"></div>
        <div style="margin-top: 10px; font-size: 14px;">
            계정이 없으신가요? <a href="signup.html">회원가입</a>
        </div>
    </div>
    
    <div class="section">
        <h2>이미지 업로드</h2>
        <div class="form-group">
            <label for="uploadImage">이미지 선택:</label>
            <input type="file" id="uploadImage" name="image" accept="image/*" capture="user">
            <img id="uploadPreview" class="preview-image">
        </div>
        <div class="form-group">
            <label for="uploadExpression">표정 선택:</label>
            <select id="uploadExpression" name="expression">
                <option value="NEUTRAL">기본 얼굴(NEUTRAL)</option>
                <option value="HAPPY">웃는 얼굴(HAPPY)</option>
                <option value="SAD">슬픈 얼굴(SAD)</option>
                <option value="ANGRY">화난 얼굴(ANGRY)</option>
                <option value="SURPRISED">놀란 얼굴(SURPRISED)</option>
            </select>
        </div>
        <button id="uploadBtn">업로드</button>
        <button id="cameraUploadBtn">카메라 열기</button>
    </div>
    
    <div class="section">
        <h2>이미지 수정</h2>
        <div class="form-group">
            <label for="updateImage">새 이미지 선택:</label>
            <input type="file" id="updateImage" name="image" accept="image/*" capture="user">
            <img id="updatePreview" class="preview-image">
        </div>
        <div class="form-group">
            <label for="updateExpression">표정 선택:</label>
            <select id="updateExpression" name="expression">
                <option value="NEUTRAL">기본 얼굴(NEUTRAL)</option>
                <option value="HAPPY">웃는 얼굴(HAPPY)</option>
                <option value="SAD">슬픈 얼굴(SAD)</option>
                <option value="ANGRY">화난 얼굴(ANGRY)</option>
                <option value="SURPRISED">놀란 얼굴(SURPRISED)</option>
            </select>
        </div>
        <button id="updateBtn">수정</button>
        <button id="cameraUpdateBtn">카메라 열기</button>
    </div>
    
    <div class="section">
        <h2>이미지 삭제</h2>
        <div class="form-group">
            <label for="deleteExpression">표정 선택:</label>
            <select id="deleteExpression" name="expression">
                <option value="NEUTRAL">기본 얼굴(NEUTRAL)</option>
                <option value="HAPPY">웃는 얼굴(HAPPY)</option>
                <option value="SAD">슬픈 얼굴(SAD)</option>
                <option value="ANGRY">화난 얼굴(ANGRY)</option>
                <option value="SURPRISED">놀란 얼굴(SURPRISED)</option>
            </select>
        </div>
        <button id="deleteBtn">삭제</button>
    </div>
    
    <div class="section">
        <h2>이미지 조회</h2>
        <button id="getImagesBtn">이미지 조회</button>
        <div class="image-container" id="imageContainer"></div>
    </div>
    
    <div id="results">
        <h3>결과:</h3>
        <pre id="resultContent"></pre>
    </div>
    
    <div class="nav-links">
        <a href="index.html">메인 페이지</a> |
        <a href="user-audio.html">음성 파일 관리</a> |
        <a href="signup.html">회원가입</a>
    </div>

    <!-- 카메라 컨테이너 -->
    <div id="camera-container">
        <video id="camera-view" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="camera-buttons">
            <button id="take-photo-btn">사진 촬영</button>
            <button id="close-camera-btn">닫기</button>
        </div>
    </div>

    <script>
        let token = '';
        let currentAction = ''; // 현재 카메라 작업 ('upload' 또는 'update')
        let stream = null;
        const cameraContainer = document.getElementById('camera-container');
        const cameraView = document.getElementById('camera-view');
        const canvas = document.getElementById('canvas');
        
        // 미리보기 이미지 핸들러
        function handleFilePreview(fileInput, previewImage) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // 파일 미리보기 초기화
        handleFilePreview(document.getElementById('uploadImage'), document.getElementById('uploadPreview'));
        handleFilePreview(document.getElementById('updateImage'), document.getElementById('updatePreview'));
        
        // 카메라 열기
        async function openCamera(action) {
            currentAction = action;
            try {
                // 전면 카메라 사용을 시도합니다
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: false
                });
                
                cameraView.srcObject = stream;
                cameraContainer.style.display = 'flex';
                
            } catch (error) {
                alert('카메라에 접근할 수 없습니다: ' + error.message);
                console.error('카메라 에러:', error);
            }
        }
        
        // 카메라 닫기
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraContainer.style.display = 'none';
            currentAction = '';
        }
        
        // 사진 캡처
        function capturePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = cameraView.videoWidth;
            canvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
            
            // 캡처된 이미지를 Blob으로 변환
            canvas.toBlob((blob) => {
                const file = new File([blob], "camera_photo.jpg", { type: "image/jpeg" });
                
                if (currentAction === 'upload') {
                    const uploadInput = document.getElementById('uploadImage');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    uploadInput.files = dataTransfer.files;
                    document.getElementById('uploadPreview').src = URL.createObjectURL(blob);
                    document.getElementById('uploadPreview').style.display = 'block';
                } else if (currentAction === 'update') {
                    const updateInput = document.getElementById('updateImage');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    updateInput.files = dataTransfer.files;
                    document.getElementById('updatePreview').src = URL.createObjectURL(blob);
                    document.getElementById('updatePreview').style.display = 'block';
                }
                
                closeCamera();
            }, 'image/jpeg', 0.9);
        }
        
        // 카메라 버튼 이벤트
        document.getElementById('cameraUploadBtn').addEventListener('click', () => openCamera('upload'));
        document.getElementById('cameraUpdateBtn').addEventListener('click', () => openCamera('update'));
        document.getElementById('take-photo-btn').addEventListener('click', capturePhoto);
        document.getElementById('close-camera-btn').addEventListener('click', closeCamera);
        
        // 로그인
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const loginId = document.getElementById('loginId').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/user/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ loginId, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    token = data.data.accessToken;
                    document.getElementById('tokenInfo').textContent = `로그인 성공! 토큰: ${token.substring(0, 15)}...`;
                    showResult('로그인 성공', data);
                } else {
                    showResult('로그인 실패', data);
                }
            } catch (error) {
                showResult('로그인 중 오류 발생', error);
            }
        });
        
        // 이미지 업로드
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            const imageFile = document.getElementById('uploadImage').files[0];
            const expression = document.getElementById('uploadExpression').value;
            
            if (!imageFile) {
                alert('이미지를 선택해주세요');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('expression', expression);
            
            console.log('업로드할 이미지:', imageFile);
            console.log('선택한 표정:', expression);
            
            try {
                const response = await fetch('/api/user/images', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                console.log('업로드 응답:', data);
                
                if (response.ok) {
                    showResult('이미지 업로드 성공', data);
                    document.getElementById('uploadImage').value = '';
                    document.getElementById('uploadPreview').style.display = 'none';
                    
                    // 업로드 성공 후 이미지 목록 자동 갱신
                    document.getElementById('getImagesBtn').click();
                } else {
                    showResult('이미지 업로드 실패', data);
                    console.error('업로드 실패:', data);
                }
            } catch (error) {
                showResult('이미지 업로드 중 오류 발생', error);
                console.error('업로드 오류:', error);
            }
        });
        
        // 이미지 수정
        document.getElementById('updateBtn').addEventListener('click', async () => {
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            const imageFile = document.getElementById('updateImage').files[0];
            const expression = document.getElementById('updateExpression').value;
            
            if (!imageFile) {
                alert('이미지를 선택해주세요');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('expression', expression);
            
            console.log('수정할 이미지:', imageFile);
            console.log('선택한 표정:', expression);
            
            try {
                const response = await fetch('/api/user/images', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                console.log('수정 응답:', data);
                
                if (response.ok) {
                    showResult('이미지 수정 성공', data);
                    document.getElementById('updateImage').value = '';
                    document.getElementById('updatePreview').style.display = 'none';
                    
                    // 수정 성공 후 이미지 목록 자동 갱신
                    document.getElementById('getImagesBtn').click();
                } else {
                    showResult('이미지 수정 실패', data);
                    console.error('수정 실패:', data);
                }
            } catch (error) {
                showResult('이미지 수정 중 오류 발생', error);
                console.error('수정 오류:', error);
            }
        });
        
        // 이미지 삭제
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            const expression = document.getElementById('deleteExpression').value;
            console.log('삭제할 표정:', expression);
            
            // 삭제 확인
            if (!confirm(`${expression} 표정 이미지를 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/user/images?expression=${expression}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('삭제 응답:', data);
                
                if (response.ok) {
                    showResult('이미지 삭제 성공', data);
                    
                    // 삭제 성공 후 이미지 목록 자동 갱신
                    document.getElementById('getImagesBtn').click();
                } else {
                    showResult('이미지 삭제 실패', data);
                    console.error('삭제 실패:', data);
                }
            } catch (error) {
                showResult('이미지 삭제 중 오류 발생', error);
                console.error('삭제 오류:', error);
            }
        });
        
        // 이미지 조회
        document.getElementById('getImagesBtn').addEventListener('click', async () => {
            if (!token) {
                alert('로그인이 필요합니다');
                return;
            }
            
            try {
                const response = await fetch('/api/user/images', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('이미지 조회 성공', data);
                    console.log('이미지 데이터:', data);
                    
                    // 이미지 목록 표시
                    const imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = '';
                    
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(image => {
                            console.log('이미지 항목:', image);
                            
                            const card = document.createElement('div');
                            card.className = 'image-card';
                            
                            const img = document.createElement('img');
                            
                            // 이미지 경로 확인 및 처리
                            if (image.imagePath) {
                                img.src = image.imagePath;
                                img.onerror = () => {
                                    console.error('이미지 로드 실패:', image.imagePath);
                                    img.src = 'https://via.placeholder.com/150?text=이미지+없음';
                                };
                            } else {
                                console.warn('이미지 경로 없음:', image);
                                img.src = 'https://via.placeholder.com/150?text=이미지+없음';
                            }
                            
                            img.alt = `${image.expression || '알 수 없음'} 이미지`;
                            
                            const info = document.createElement('p');
                            info.textContent = `표정: ${image.expression || '알 수 없음'}`;
                            
                            card.appendChild(img);
                            card.appendChild(info);
                            imageContainer.appendChild(card);
                        });
                    } else {
                        imageContainer.innerHTML = '<p>등록된 이미지가 없습니다.</p>';
                    }
                } else {
                    showResult('이미지 조회 실패', data);
                }
            } catch (error) {
                showResult('이미지 조회 중 오류 발생', error);
                console.error('이미지 조회 오류:', error);
            }
        });
        
        // 결과 표시
        function showResult(title, data) {
            const resultContent = document.getElementById('resultContent');
            resultContent.textContent = `${title}\n${JSON.stringify(data, null, 2)}`;
        }
    </script>
</body>
</html> 